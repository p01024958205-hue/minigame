<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Mini Galaga Classic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    body{margin:0;background:#000;display:flex;justify-content:center;align-items:center;height:100vh;font-family:Arial;color:#fff}
    canvas{image-rendering:pixelated;border:2px solid #333;background:#000;touch-action:none}
    #ui{position:fixed;top:6px;width:100%;text-align:center;font-size:12px;color:#0f0}
    #hint{position:fixed;bottom:6px;width:100%;text-align:center;font-size:11px;color:#aaa}
  </style>
</head>
<body>
<canvas id="game" width="240" height="320"></canvas>
<div id="ui"></div>
<div id="hint">드래그 이동 / 자동 발사</div>
<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const ui=document.getElementById('ui');

/* ===== 상태 ===== */
let score=0, high=localStorage.getItem('galaga_hs')||0;
let lives=3, round=1, gameOver=false;

/* ===== 플레이어 (비행기 도트 스프라이트) ===== */
const player={x:120,y:270,s:2};
const ship=[[0,1,0],[1,1,1],[0,1,0]];

/* ===== 입력 ===== */
let dirX=0,dirY=0,start=null;
canvas.addEventListener('touchstart',e=>{start={x:e.touches[0].clientX,y:e.touches[0].clientY}});
canvas.addEventListener('touchmove',e=>{if(!start)return;let dx=e.touches[0].clientX-start.x;let dy=e.touches[0].clientY-start.y;let l=Math.hypot(dx,dy)||1;dirX=dx/l;dirY=dy/l});
canvas.addEventListener('touchend',()=>{dirX=dirY=0;start=null});

/* ===== 엔티티 ===== */
let bullets=[], enemies=[];
setInterval(()=>{if(!gameOver)bullets.push({x:player.x,y:player.y})},350);

/* ===== 적 편대 (천천히 내려오며 쌓임) ===== */
function spawnFormation(){
  for(let r=0;r<2;r++)for(let c=0;c<8;c++)enemies.push({x:40+c*20,y:30+r*16,dx:0.4});
}

/* ===== 업데이트 ===== */
function update(){
  if(gameOver)return;
  player.x+=dirX*player.s; player.y+=dirY*player.s;
  player.x=Math.max(10,Math.min(230,player.x)); player.y=Math.max(200,Math.min(300,player.y));

  bullets.forEach(b=>b.y-=4); bullets=bullets.filter(b=>b.y>-10);

  let edge=false;
  enemies.forEach(e=>{e.x+=e.dx;if(e.x<20||e.x>220)edge=true});
  if(edge)enemies.forEach(e=>{e.dx*=-1;e.y+=10});

  bullets.forEach((b,bi)=>{
    enemies.forEach((e,ei)=>{
      if(Math.abs(b.x-e.x)<6&&Math.abs(b.y-e.y)<6){bullets.splice(bi,1);enemies.splice(ei,1);score+=10}
    })
  });

  enemies.forEach(e=>{if(Math.abs(e.x-player.x)<8&&Math.abs(e.y-player.y)<8){lose()}});

  if(enemies.length===0){round++; if(round>10)end(true); else spawnFormation()}
}

function lose(){lives--; if(lives<=0)end(false)}
function end(win){gameOver=true; if(score>high){high=score;localStorage.setItem('galaga_hs',score)}}

/* ===== 렌더 ===== */
function px(x,y,c){ctx.fillStyle=c;ctx.fillRect(x,y,3,3)}
function drawShip(x,y,c){ship.forEach((r,i)=>r.forEach((v,j)=>{if(v)px(x+j*3-3,y+i*3,c)}))}

function draw(){
  ctx.clearRect(0,0,240,320);
  drawShip(player.x,player.y,'#0f0');
  bullets.forEach(b=>px(b.x,b.y,'#ff0'));
  enemies.forEach(e=>drawShip(e.x,e.y,'#f00'));
  ui.innerText=`ROUND ${round}  LIFE ${lives}  SCORE ${score}  HI ${high}`;
  if(gameOver){ctx.fillStyle='#fff';ctx.fillText('GAME OVER',80,160)}
}

function loop(){update();draw();requestAnimationFrame(loop)}
spawnFormation(); loop();
</script>
</body>
</html>
