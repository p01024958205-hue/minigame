<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Dungeon Origin : ROOT</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
<style>
body { margin:0; background:black; touch-action:none; }
</style>
</head>
<body>

<script>
/* =====================================================
   GLOBAL DATA
===================================================== */
const ROOM_FLOW = [
  ...Array(8).fill({type:'NORMAL'}),
  {type:'TREASURE'},
  {type:'ELITE'},
  ...Array(6).fill({type:'NORMAL'}),
  {type:'MINI_BOSS'},
  ...Array(10).fill({type:'NORMAL'}),
  {type:'BOSS'}
];

const WEAPONS = {
  일반:[
    {name:'녹슨 검',color:0xffffff,dmg:6,skills:[]},
    {name:'짧은 도끼',color:0xffffff,dmg:7,skills:[]},
    {name:'목검',color:0xffffff,dmg:5,skills:[]},
    {name:'낡은 창',color:0xffffff,dmg:6,skills:[]},
    {name:'돌망치',color:0xffffff,dmg:8,skills:[]}
  ],
  희귀:[
    {name:'푸른 검',color:0x4fc3f7,dmg:12,
     skills:[{mp:20,action:(s)=>s.flash(0x4fc3f7)}]},
    {name:'빙결 도끼',color:0x4fc3f7,dmg:13,
     skills:[{mp:20,action:(s)=>s.freezeEnemies()}]}
  ],
  에픽:[
    {name:'어둠의 검',color:0xba68c8,dmg:20,
     skills:[
      {mp:20,action:(s)=>s.darkSlash()},
      {mp:30,action:(s)=>s.darkWave()}
     ]}
  ],
  전설:[
    {name:'태양의 대검',color:0xffca28,dmg:32,
     skills:[
      {mp:30,action:(s)=>s.fireSpin()},
      {mp:50,action:(s)=>s.sunCrash()}
     ]}
  ],
  근본:[
    {name:'태초의 균열검',color:0xff3d00,dmg:60,
     skills:[
      {mp:30,action:(s)=>s.rootWave()},
      {mp:70,action:(s)=>s.worldBreak()}
     ]}
  ]
};

let ROOM_INDEX = 0;

/* =====================================================
   INTRO SCENE
===================================================== */
class IntroScene extends Phaser.Scene {
  constructor(){ super('Intro'); }
  create(){
    this.add.text(180,300,'Dungeon Origin',{
      fontSize:'30px',color:'#fff'
    }).setOrigin(0.5);
    this.add.text(180,340,'ROOT',{
      fontSize:'18px',color:'#ff3d00'
    }).setOrigin(0.5);
    this.time.delayedCall(2500,()=>this.scene.start('Game'));
  }
}

/* =====================================================
   GAME SCENE
===================================================== */
class GameScene extends Phaser.Scene {
  constructor(){ super('Game'); }

  create(){
    this.player=this.physics.add.sprite(180,320)
      .setSize(26,38).setTint(0x00ff99);
    this.player.hp=100;
    this.player.mp=50;
    this.player.weapon=WEAPONS.일반[0];

    this.hpBar=this.add.rectangle(90,18,160,10,0xff4444);
    this.mpBar=this.add.rectangle(90,34,160,8,0x448aff);

    this.move={u:0,d:0,l:0,r:0};
    this.createControls();

    this.monsters=this.physics.add.group();
    this.bossGroup=this.physics.add.group();

    this.loadRoom();

    this.physics.add.overlap(this.player,this.monsters,this.hitEnemy,null,this);
    this.physics.add.overlap(this.player,this.bossGroup,this.hitBoss,null,this);
  }

  createControls(){
    const btn=(x,y,t,cb)=>{
      let b=this.add.text(x,y,t,{fontSize:'20px',backgroundColor:'#333'})
        .setOrigin(0.5).setInteractive();
      b.on('pointerdown',()=>cb(1));
      b.on('pointerup',()=>cb(0));
    };
    btn(60,520,'↑',v=>this.move.u=v);
    btn(60,580,'↓',v=>this.move.d=v);
    btn(20,550,'←',v=>this.move.l=v);
    btn(100,550,'→',v=>this.move.r=v);

    this.add.text(280,530,'SKILL1',{fontSize:'14px',backgroundColor:'#555'})
      .setInteractive().on('pointerdown',()=>this.useSkill(0));
    this.add.text(280,570,'SKILL2',{fontSize:'14px',backgroundColor:'#777'})
      .setInteractive().on('pointerdown',()=>this.useSkill(1));
  }

  loadRoom(){
    this.monsters.clear(true,true);
    this.bossGroup.clear(true,true);

    let room=ROOM_FLOW[ROOM_INDEX];
    if(room.type==='BOSS') return this.spawnBoss();
    if(room.type==='MINI_BOSS') return this.spawnMiniBoss();
    if(room.type==='TREASURE') return this.spawnChest();

    let count=room.type==='ELITE'?3:5;
    for(let i=0;i<count;i++){
      let m=this.monsters.create(
        Phaser.Math.Between(40,320),
        Phaser.Math.Between(80,480)
      );
      m.hp=30+ROOM_INDEX*5;
    }
  }

  spawnBoss(){
    let b=this.bossGroup.create(180,200)
      .setTint(0xff0000).setScale(2);
    b.hp=600;
    b.phase=1;
    this.boss=b;
  }

  spawnMiniBoss(){
    let b=this.bossGroup.create(180,200)
      .setTint(0xff9800).setScale(1.5);
    b.hp=300;
    b.phase=1;
  }

  hitEnemy(p,m){
    m.hp-=this.player.weapon.dmg*0.03;
    p.hp-=0.05;
    if(m.hp<=0){
      this.dropWeapon(m.x,m.y);
      m.destroy();
      if(this.monsters.countActive()===0) this.spawnKey();
    }
  }

  hitBoss(p,b){
    p.hp-=0.15;
    b.hp-=this.player.weapon.dmg*0.04;
    if(b.hp<400) b.phase=2;
    if(b.hp<200) b.phase=3;
    this.bossAI(b);
    if(b.hp<=0){ b.destroy(); this.spawnKey(); }
  }

  bossAI(b){
    let sp=[60,120,200][b.phase-1];
    this.physics.moveToObject(b,this.player,sp);
    if(b.phase===3) this.flash(0xff1744);
  }

  spawnKey(){
    let k=this.add.rectangle(180,320,14,14,0xffeb3b)
      .setInteractive();
    k.on('pointerdown',()=>{
      k.destroy();
      this.spawnPortal();
    });
  }

  spawnPortal(){
    let p=this.add.rectangle(180,200,30,30,0x00e5ff)
      .setInteractive();
    p.on('pointerdown',()=>{
      ROOM_INDEX++;
      this.loadRoom();
      p.destroy();
    });
  }

  spawnChest(){
    let c=this.add.rectangle(180,300,26,20,0x795548)
      .setInteractive();
    c.on('pointerdown',()=>{
      this.dropWeapon(c.x,c.y,true);
      this.spawnPortal();
      c.destroy();
    });
  }

  dropWeapon(x,y,high=false){
    let grades=Object.keys(WEAPONS);
    let g=grades[Phaser.Math.Between(high?1:0,grades.length-1)];
    let wData=Phaser.Utils.Array.GetRandom(WEAPONS[g]);
    let w=this.add.rectangle(x,y,16,16,wData.color)
      .setInteractive();
    w.on('pointerdown',()=>{
      this.player.weapon=wData;
      w.destroy();
    });
  }

  useSkill(i){
    let s=this.player.weapon.skills?.[i];
    if(!s||this.player.mp<s.mp) return;
    this.player.mp-=s.mp;
    s.action(this);
  }

  /* ====== SKILL EFFECTS ====== */
  darkSlash(){ this.flash(0x000000); }
  darkWave(){ this.monsters.children.iterate(m=>m&& (m.hp-=40)); }
  fireSpin(){ this.flash(0xff5722); }
  sunCrash(){ this.monsters.children.iterate(m=>m&&(m.hp-=80)); }
  rootWave(){ this.flash(0xff3d00); }
  worldBreak(){
    this.flash(0xff0000);
    this.monsters.children.iterate(m=>m&&(m.hp=0));
    if(this.boss) this.boss.hp-=200;
  }
  freezeEnemies(){ this.flash(0x4fc3f7); }

  flash(color){
    let r=this.add.rectangle(180,320,360,640,color).setAlpha(0.3);
    this.tweens.add({targets:r,alpha:0,duration:300,onComplete:()=>r.destroy()});
  }

  update(){
    let s=120;
    this.player.setVelocity(
      (this.move.r-this.move.l)*s,
      (this.move.d-this.move.u)*s
    );
    this.hpBar.width=Math.max(0,this.player.hp*1.6);
    this.mpBar.width=Math.max(0,this.player.mp*3.2);
    if(this.player.hp<=0) this.scene.start('GameOver');
  }
}

/* =====================================================
   GAME OVER
===================================================== */
class GameOverScene extends Phaser.Scene{
  constructor(){super('GameOver');}
  create(){
    this.add.text(180,300,'YOU DIED',{fontSize:'32px',color:'#ff4444'})
      .setOrigin(0.5);
    this.add.text(180,360,'RETRY',{fontSize:'20px',backgroundColor:'#333'})
      .setOrigin(0.5).setInteractive()
      .on('pointerdown',()=>{
        ROOM_INDEX=0;
        this.scene.start('Game');
      });
  }
}

/* =====================================================
   CONFIG
===================================================== */
new Phaser.Game({
  type:Phaser.AUTO,
  width:360,
  height:640,
  physics:{default:'arcade',arcade:{debug:false}},
  scene:[IntroScene,GameScene,GameOverScene]
});
</script>
</body>
</html>
